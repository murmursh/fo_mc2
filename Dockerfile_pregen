# Stage 1: Build the modpack using packwiz
FROM debian:stable-slim AS packwiz-builder

# Install necessary tools (curl, unzip, etc.)
RUN apt-get update && apt-get install -y curl unzip && rm -rf /var/lib/apt/lists/*

# Install packwiz
RUN curl -Lo packwiz.zip https://nightly.link/packwiz/packwiz/workflows/go/main/Linux%2064-bit%20x86.zip && \
    unzip packwiz.zip -d /usr/local/bin && \
    rm packwiz.zip

# Set working directory for packwiz
WORKDIR /app/mc_pack

# Copy the modpack definition files
COPY mc_pack/ ./

# Build the .mrpack file
# The output will be in /app/mc_pack/bs_craft-9.0.0.mrpack
RUN packwiz refresh
RUN packwiz modrinth export

# Stage 2: Final Minecraft server image
FROM itzg/minecraft-server

# Set the Minecraft version (must match your modpack)
ENV TYPE=FABRIC
ENV EULA=TRUE
ENV VERSION=1.21.5

# Copy the built modpack from the builder stage
COPY --from=packwiz-builder /app/mc_pack/bs_craft-9.0.0.mrpack /modpack.mrpack

# Set the modpack file for the server
ENV MODPACK_FILE=/modpack.mrpack

# Command to run after server startup for pregeneration
ENV SERVER_STARTUP_COMMAND="/usr/bin/rcon-cli dh pregen"
